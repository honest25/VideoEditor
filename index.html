<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gemini Ultra - Real Processing Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        .clip-active { border: 3px solid #3b82f6 !important; background: #1e293b !important; scale: 1.05; }
        .timeline-scroll::-webkit-scrollbar { height: 8px; }
        .timeline-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="bg-[#020617] text-white h-screen flex flex-col overflow-hidden">

    <nav class="h-16 bg-slate-900 border-b border-slate-800 flex justify-between items-center px-6">
        <div class="flex items-center gap-2">
            <span class="bg-blue-600 p-1 rounded font-bold">G</span>
            <span class="font-black italic text-xl">ULTRA <span class="text-blue-500 text-sm">PRO</span></span>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('vidInp').click()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-xs font-bold">+ IMPORT VIDEO</button>
            <button onclick="startProcessing()" id="renderBtn" class="bg-green-600 hover:bg-green-500 px-6 py-2 rounded text-xs font-black shadow-lg shadow-green-900/20">RENDER & DOWNLOAD</button>
        </div>
        <input type="file" id="vidInp" multiple hidden accept="video/*" onchange="handleFiles(this.files)">
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-72 bg-slate-900 border-r border-slate-800 p-4 space-y-6">
            <h2 class="text-[10px] font-bold text-slate-500 tracking-widest uppercase">Clip Settings</h2>
            
            <div id="inspector" class="hidden space-y-4">
                <div>
                    <label class="text-[10px] text-slate-400">TEXT OVERLAY</label>
                    <input type="text" id="t_text" class="w-full bg-black border border-slate-700 p-2 rounded text-sm mt-1" oninput="saveData()">
                </div>
                <div>
                    <label class="text-[10px] text-slate-400">FILTER</label>
                    <select id="t_filter" class="w-full bg-black border border-slate-700 p-2 rounded text-sm mt-1" onchange="saveData()">
                        <option value="none">Normal</option>
                        <option value="bw">Black & White</option>
                        <option value="sepia">Sepia Vintage</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-slate-400">SPEED (0.5x - 2.0x)</label>
                    <input type="range" id="t_speed" min="0.5" max="2" step="0.1" value="1" class="w-full" oninput="saveData()">
                    <div id="speedVal" class="text-[10px] text-center text-blue-400">1.0x</div>
                </div>
            </div>
            <div id="placeholder" class="text-slate-600 text-xs italic">Select a clip to edit...</div>
        </aside>

        <main class="flex-1 flex flex-col relative">
            <div class="flex-1 flex items-center justify-center p-6 bg-black">
                <video id="mainPlayer" class="max-h-full rounded border border-slate-800 shadow-2xl" controls></video>
                
                <div id="renderOverlay" class="hidden absolute inset-0 bg-slate-950/90 z-50 flex flex-col items-center justify-center">
                    <div class="w-64 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                        <div id="pBar" class="w-0 h-full bg-blue-500 transition-all duration-300"></div>
                    </div>
                    <p id="pStatus" class="mt-4 font-mono text-xs text-blue-400 animate-pulse">Initializing Engine...</p>
                </div>
            </div>

            <div class="h-48 bg-slate-900 border-t border-slate-800 p-4">
                <p class="text-[10px] text-slate-500 font-bold mb-3 uppercase tracking-tighter">Timeline Track</p>
                <div id="timeline" class="flex gap-4 overflow-x-auto timeline-scroll h-24 items-center px-2">
                    </div>
            </div>
        </main>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        // SINGLE THREADED MODE FOR BROWSER COMPATIBILITY
        const ffmpeg = createFFmpeg({ log: true });
        let clips = [];
        let activeIdx = -1;

        async function initFFmpeg() {
            try {
                if (!ffmpeg.isLoaded()) await ffmpeg.load();
                console.log("FFmpeg Loaded Successfully");
            } catch (e) {
                alert("FFmpeg Load Error: Use Chrome or Local Server (Live Server)");
            }
        }
        initFFmpeg();

        function handleFiles(files) {
            for (let f of files) {
                clips.push({
                    file: f,
                    url: URL.createObjectURL(f),
                    name: f.name,
                    text: '',
                    filter: 'none',
                    speed: 1.0
                });
            }
            renderTimeline();
        }

        function renderTimeline() {
            const tl = document.getElementById('timeline');
            tl.innerHTML = '';
            clips.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = `min-w-[150px] h-16 rounded bg-slate-800 p-2 cursor-pointer border ${activeIdx === i ? 'clip-active' : 'border-slate-700'}`;
                div.innerHTML = `<div class="text-[9px] truncate">${c.name}</div><div class="text-[8px] text-blue-400 mt-2">${c.filter} | ${c.speed}x</div>`;
                div.onclick = () => selectClip(i);
                tl.appendChild(div);
            });
        }

        function selectClip(i) {
            activeIdx = i;
            const c = clips[i];
            document.getElementById('mainPlayer').src = c.url;
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('inspector').classList.remove('hidden');
            
            document.getElementById('t_text').value = c.text;
            document.getElementById('t_filter').value = c.filter;
            document.getElementById('t_speed').value = c.speed;
            document.getElementById('speedVal').innerText = c.speed + 'x';
            renderTimeline();
        }

        function saveData() {
            if (activeIdx === -1) return;
            clips[activeIdx].text = document.getElementById('t_text').value;
            clips[activeIdx].filter = document.getElementById('t_filter').value;
            clips[activeIdx].speed = document.getElementById('t_speed').value;
            document.getElementById('speedVal').innerText = clips[activeIdx].speed + 'x';
            renderTimeline();
        }

        // REAL PERFORMANCE: FFmpeg Command Execution
        async function startProcessing() {
            if (clips.length === 0) return alert("Please import a video first!");
            
            const overlay = document.getElementById('renderOverlay');
            const status = document.getElementById('pStatus');
            const bar = document.getElementById('pBar');
            
            overlay.classList.remove('hidden');
            status.innerText = "Loading assets into memory...";

            try {
                // 1. Write files to FFmpeg Virtual System
                for (let i = 0; i < clips.length; i++) {
                    ffmpeg.FS('writeFile', `input${i}.mp4`, await fetchFile(clips[i].file));
                }

                // 2. Build Complex Filter for REAL Processing
                // This chain handles Scaling, Filters, Speed, and Text in one go
                let filterStr = "";
                for (let i = 0; i < clips.length; i++) {
                    let vTag = `[${i}:v]`;
                    let fx = `scale=1280:720,setsar=1`;
                    
                    if (clips[i].filter === 'bw') fx += `,hue=s=0`;
                    if (clips[i].filter === 'sepia') fx += `,colorchannelmixer=.393:.769:.189:0:.349:.686:.168:0:.272:.534:.131`;
                    
                    fx += `,setpts=${1/clips[i].speed}*PTS`;
                    
                    if (clips[i].text) {
                        // drawtext works if fonts are loaded, using simple box for fallback
                        fx += `,drawtext=text='${clips[i].text}':x=(w-text_w)/2:y=h-80:fontsize=40:fontcolor=white:box=1:boxcolor=black@0.5`;
                    }
                    
                    filterStr += `${vTag}${fx}[v${i}out]; [${i}:a]atempo=${clips[i].speed}[a${i}out]; `;
                }

                // Concatenate everything
                let concat = "";
                for (let i = 0; i < clips.length; i++) concat += `[v${i}out][a${i}out]`;
                filterStr += `${concat}concat=n=${clips.length}:v=1:a=1[vfinal][afinal]`;

                status.innerText = "FFmpeg: Rendering Frames (Pixel Processing)...";
                bar.style.width = "50%";

                // 3. EXECUTE REAL COMMAND
                await ffmpeg.run(
                    ...clips.flatMap((_, i) => ['-i', `input${i}.mp4`]),
                    '-filter_complex', filterStr,
                    '-map', '[vfinal]', '-map', '[afinal]',
                    '-c:v', 'libx264',
                    '-preset', 'ultrafast',
                    'output.mp4'
                );

                // 4. DOWNLOAD RESULT
                status.innerText = "Finalizing File...";
                bar.style.width = "100%";
                
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                const link = document.createElement('a');
                link.href = url;
                link.download = "Gemini_Ultra_Edit.mp4";
                link.click();

            } catch (err) {
                console.error(err);
                alert("FFmpeg Error: " + err.message);
            } finally {
                overlay.classList.add('hidden');
                bar.style.width = "0%";
            }
        }
    </script>
</body>
</html>
