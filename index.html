<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gemini Ultra V18 - 4K Export Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        .clip-active { border: 2px solid #3b82f6; background: #1e293b; }
        .insta-cyberpunk { filter: hue-rotate(160deg) saturate(1.8) contrast(1.2); }
        .insta-vintage { filter: sepia(0.6) contrast(0.9) brightness(1.1); }
        .insta-golden { filter: sepia(0.3) saturate(2.2) hue-rotate(-15deg); }
        .insta-horror { filter: grayscale(0.5) sepia(1) hue-rotate(70deg); }
        input[type="range"] { accent-color: #3b82f6; }
        select { outline: none; transition: 0.3s; }
        select:focus { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <nav class="h-14 bg-slate-900 border-b border-slate-800 flex justify-between items-center px-6">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white px-2 py-0.5 rounded font-black italic text-xs">V18</div>
            <h1 class="font-bold text-xs tracking-widest uppercase">Export Suite</h1>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-slate-800 p-1.5 rounded-lg border border-slate-700">
                <span class="text-[9px] font-bold text-slate-400 pl-2 uppercase">Quality:</span>
                <select id="resSelect" class="bg-slate-900 text-[10px] font-bold px-3 py-1 rounded border border-slate-700 text-blue-400">
                    <option value="3840:2160">4K (Ultra HD)</option>
                    <option value="2560:1440">2K (Quad HD)</option>
                    <option value="1920:1080" selected>1080p (Full HD)</option>
                    <option value="1280:720">720p (HD)</option>
                </select>
            </div>
            
            <button onclick="document.getElementById('vidIn').click()" class="bg-slate-800 text-[10px] font-bold px-4 py-2 rounded">+ VIDEO</button>
            <button onclick="document.getElementById('audIn').click()" class="bg-amber-600/20 text-amber-500 border border-amber-500/30 text-[10px] font-bold px-4 py-2 rounded">+ BGM</button>
            <button onclick="renderFinalMaster()" class="bg-blue-600 text-[10px] font-black px-6 py-2 rounded shadow-lg shadow-blue-500/20 hover:bg-blue-500">RENDER & DOWNLOAD</button>
        </div>
        <input type="file" id="vidIn" multiple hidden onchange="importVideos(this.files)">
        <input type="file" id="audIn" accept="audio/*" hidden onchange="importBGM(this.files)">
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-80 bg-slate-900 border-r border-slate-800 p-5 overflow-y-auto space-y-6">
            <div id="audioTrackBox" class="hidden p-4 bg-amber-600/10 border border-amber-600/30 rounded-xl space-y-3">
                <p class="text-[10px] font-bold text-amber-500 uppercase">Music Engine</p>
                <input type="range" id="bgmVol" min="0" max="1" step="0.1" value="0.5" class="w-full" oninput="syncLive()">
                <div class="flex gap-4 text-[9px]">
                    <label class="flex items-center gap-1"><input type="checkbox" id="fIn"> FADE IN</label>
                    <label class="flex items-center gap-1"><input type="checkbox" id="fOut"> FADE OUT</label>
                </div>
            </div>

            <div id="inspector" class="hidden space-y-6">
                <label class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">Presets</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setFx('none')" class="bg-slate-800 text-[9px] p-2 rounded">Original</button>
                    <button onclick="setFx('cyberpunk')" class="bg-slate-800 text-[9px] p-2 rounded">Cyberpunk</button>
                    <button onclick="setFx('vintage')" class="bg-slate-800 text-[9px] p-2 rounded">1970s</button>
                    <button onclick="setFx('golden')" class="bg-slate-800 text-[9px] p-2 rounded">Golden</button>
                </div>
                <div class="space-y-4 pt-4 border-t border-white/5">
                    <div class="flex justify-between text-[10px]"><span>Clip Volume</span><span id="cVolVal">100%</span></div>
                    <input type="range" id="cVol" min="0" max="2" step="0.1" value="1" class="w-full" oninput="save()">
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-black relative">
            <div class="flex-1 flex items-center justify-center p-8">
                <video id="player" class="max-h-full rounded shadow-2xl transition-all" controls></video>
                <audio id="bgmPlayer" loop></audio>
                
                <div id="renderUI" class="hidden absolute inset-0 bg-slate-950/95 z-50 flex flex-col items-center justify-center">
                    <div class="w-64 h-1 bg-slate-800 rounded-full overflow-hidden mb-6">
                        <div id="pBar" class="w-0 h-full bg-blue-500 transition-all duration-300"></div>
                    </div>
                    <p id="pStatus" class="font-mono text-[10px] text-blue-400 animate-pulse uppercase tracking-[0.3em]">Encoding <span id="resTag">1080p</span> Master...</p>
                </div>
            </div>
            <div class="h-40 bg-slate-900 border-t border-slate-800 p-4 flex gap-4 overflow-x-auto scroll-hide" id="timeline"></div>
        </main>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        let clips = [];
        let activeIdx = -1;

        async function init() { await ffmpeg.load(); }
        init();

        const v = document.getElementById('player');
        const a = document.getElementById('bgmPlayer');

        v.onplay = () => { if(a.src) a.play(); };
        v.onpause = () => a.pause();
        v.onseeking = () => { if(a.src) a.currentTime = v.currentTime; };

        function importVideos(files) {
            for (let f of files) {
                clips.push({ file: f, url: URL.createObjectURL(f), start: 0, end: 5, vol: 1.0, fx: 'none' });
            }
            renderTL();
        }

        function importBGM(files) {
            a.src = URL.createObjectURL(files[0]);
            document.getElementById('audioTrackBox').classList.remove('hidden');
            syncLive();
        }

        function renderTL() {
            const tl = document.getElementById('timeline');
            tl.innerHTML = '';
            clips.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = `min-w-[140px] h-20 bg-slate-800 rounded p-3 cursor-pointer border border-slate-700 ${activeIdx === i ? 'clip-active' : ''}`;
                div.innerHTML = `<p class="text-[9px] truncate uppercase font-black">${c.file.name}</p>`;
                div.onclick = () => select(i);
                tl.appendChild(div);
            });
        }

        function select(i) {
            activeIdx = i;
            v.src = clips[i].url;
            v.className = `max-h-full rounded shadow-2xl insta-${clips[i].fx}`;
            document.getElementById('inspector').classList.remove('hidden');
            renderTL();
        }

        function setFx(fx) {
            if(activeIdx === -1) return;
            clips[activeIdx].fx = fx;
            v.className = `max-h-full rounded shadow-2xl transition-all duration-300 insta-${fx}`;
            renderTL();
        }

        function syncLive() { a.volume = document.getElementById('bgmVol').value; }
        function save() { 
            clips[activeIdx].vol = document.getElementById('cVol').value;
            document.getElementById('cVolVal').innerText = Math.round(clips[activeIdx].vol*100) + "%";
        }

        async function renderFinalMaster() {
            if(clips.length === 0) return;
            const res = document.getElementById('resSelect').value;
            document.getElementById('resTag').innerText = res.split(':')[1] + 'p';
            document.getElementById('renderUI').classList.remove('hidden');

            try {
                for(let i=0; i<clips.length; i++) {
                    ffmpeg.FS('writeFile', `v${i}.mp4`, await fetchFile(clips[i].file));
                }

                let filter = "";
                let concat = "";
                let totalDur = clips.length * 5;

                for(let i=0; i<clips.length; i++) {
                    const c = clips[i];
                    // RESOLUTION SCALING LOGIC
                    let vFx = `scale=${res}:force_original_aspect_ratio=decrease,pad=${res}:(ow-iw)/2:(oh-ih)/2,setsar=1`;
                    if(c.fx === 'cyberpunk') vFx += `,hue=h=160:s=1.8`;
                    if(c.fx === 'vintage') vFx += `,sepia=0.6`;
                    if(c.fx === 'golden') vFx += `,hue=h=-15:s=2.5`;

                    filter += `[${i}:v]${vFx}[v${i}o]; [${i}:a]volume=${c.vol}[a${i}o]; `;
                    concat += `[v${i}o][a${i}o]`;
                }

                filter += `${concat}concat=n=${clips.length}:v=1:a=1[vpre][apre];`;

                let inputs = clips.flatMap((_,i)=>['-i', `v${i}.mp4`]);
                if(a.src) {
                    ffmpeg.FS('writeFile', 'm.mp3', await fetchFile(a.src));
                    inputs.push('-i', 'm.mp3');
                    let bgmFx = `volume=${document.getElementById('bgmVol').value}`;
                    if(document.getElementById('fIn').checked) bgmFx += `,afade=t=in:ss=0:d=2`;
                    if(document.getElementById('fOut').checked) bgmFx += `,afade=t=out:st=${totalDur-2}:d=2`;
                    filter += `[${clips.length}:a]${bgmFx}[bgm_f]; [apre][bgm_f]amix=inputs=2:duration=first[afinal]`;
                } else {
                    filter += `[apre]copy[afinal]`;
                }

                // High Quality Encoding Settings
                await ffmpeg.run(...inputs, '-filter_complex', filter, '-map', '[vpre]', '-map', '[afinal]', '-c:v', 'libx264', '-crf', '18', '-preset', 'ultrafast', 'out.mp4');

                const data = ffmpeg.FS('readFile', 'out.mp4');
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([data.buffer], {type:'video/mp4'}));
                link.download = `Gemini_Master_${res.split(':')[1]}p.mp4`;
                link.click();
            } catch (e) { console.error(e); }
            finally { document.getElementById('renderUI').classList.add('hidden'); }
        }
    </script>
</body>
</html>
