<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineStudio Elite | Production Ready</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #fbbf24; --bg: #050505; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        .app-shell { display: grid; grid-template-rows: 60px 1fr 240px; height: 100vh; }
        
        /* High-Performance Canvas */
        .preview-pane { position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas { max-height: 95%; max-width: 95%; background: #111; border: 1px solid #333; aspect-ratio: 9/16; }

        /* Timeline Logic */
        .timeline-box { background: #0a0a0a; border-top: 1px solid #222; overflow-x: auto; position: relative; padding: 10px 0; }
        .track { height: 42px; border-bottom: 1px solid #1a1a1a; position: relative; min-width: 5000px; display: flex; align-items: center; }
        .clip { position: absolute; height: 34px; border-radius: 4px; padding: 0 12px; font-size: 10px; font-weight: bold; display: flex; align-items: center; color: white; border: 1px solid rgba(255,255,255,0.2); }
        .v-clip { background: linear-gradient(90deg, #1e40af, #3b82f6); }
        .a-clip { background: linear-gradient(90deg, #065f46, #10b981); }
        .playhead { width: 2px; height: 100%; background: #ff0000; position: absolute; left: 0; z-index: 50; pointer-events: none; box-shadow: 0 0 10px red; }

        /* Navigation Dock */
        .dock { background: #000; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #222; padding: 10px 0; }
        .tool-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; color: #888; background: none; border: none; cursor: pointer; }
        .active { color: var(--gold); }
        
        /* Safe Zones */
        #safe-zone { position: absolute; border: 1px dashed rgba(251, 191, 36, 0.4); pointer-events: none; display: none; }
    </style>
</head>
<body>

<div class="app-shell">
    <header class="flex items-center justify-between px-4 border-b border-zinc-800 bg-black">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-bolt text-amber-500"></i>
            <input type="text" id="p-name" value="CINEMATIC_REEL_01" class="bg-transparent text-zinc-300 font-black outline-none w-40 text-sm">
        </div>
        <button onclick="exportVideo()" class="bg-amber-500 text-black px-5 py-1.5 rounded-full text-[10px] font-black uppercase">Render</button>
    </header>

    <main class="preview-pane">
        <canvas id="mainCanvas"></canvas>
        <div id="safe-zone"></div>
        <div id="loader" class="absolute text-[10px] text-amber-500 font-bold uppercase tracking-widest">Waiting for Media...</div>
        
        <button onclick="togglePlayback()" id="playBtn" class="absolute bottom-6 w-14 h-14 bg-white/10 backdrop-blur-xl rounded-full border border-white/20 flex items-center justify-center transition-transform active:scale-90">
            <i class="fa-solid fa-play text-xl" id="playIcon"></i>
        </button>
    </main>

    <section class="flex flex-col">
        <div class="timeline-box" id="timeline">
            <div class="playhead" id="playhead"></div>
            <div class="track" id="v-track"></div>
            <div class="track" id="a-track"></div>
        </div>
        
        <div class="p-2 px-4 bg-zinc-900 flex items-center gap-6">
            <span class="text-[9px] font-bold text-zinc-500">SPEED RAMP</span>
            <input type="range" id="speedRamp" min="0.5" max="2.0" step="0.1" value="1" class="w-full accent-amber-500">
        </div>

        <nav class="dock">
            <label class="tool-btn">
                <i class="fa-solid fa-plus-square text-lg"></i><span>Add Media</span>
                <input type="file" id="fileInput" hidden multiple accept="video/*,audio/*,image/*">
            </label>
            <button onclick="applyFX('chroma')" id="chromaBtn" class="tool-btn">
                <i class="fa-solid fa-wand-magic-sparkles text-lg"></i><span>Keyer</span>
            </button>
            <button onclick="applyFX('grain')" id="grainBtn" class="tool-btn">
                <i class="fa-solid fa-film text-lg"></i><span>Grain</span>
            </button>
            <button onclick="toggleSafeZones()" id="szBtn" class="tool-btn">
                <i class="fa-solid fa-border-all text-lg"></i><span>Safe Zone</span>
            </button>
        </nav>
    </section>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    let video = null, audio = null, isPlaying = false;
    let useChroma = false, useGrain = false;

    // Initialization
    canvas.width = 1080; canvas.height = 1920;

    // --- File Handling ---
    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        const url = URL.createObjectURL(file);
        const type = file.type.split('/')[0];

        if(type === 'video') {
            video = document.createElement('video');
            video.src = url; 
            video.muted = true; // Essential for browser auto-play
            video.playsInline = true;
            video.loop = true;
            video.onloadeddata = () => {
                document.getElementById('loader').style.display = 'none';
                updateSafeZoneUI();
                renderLoop();
            };
            createClipUI(file.name, 'v-clip', 'v-track');
        } else if(type === 'audio') {
            audio = new Audio(url);
            createClipUI(file.name, 'a-clip', 'a-track');
        }
    };

    function createClipUI(name, css, trackId) {
        const clip = document.createElement('div');
        clip.className = `clip ${css}`;
        clip.style.left = "20px"; clip.style.width = "200px";
        clip.innerText = name.substring(0, 10) + "...";
        document.getElementById(trackId).appendChild(clip);
    }

    // --- Core FX Logic ---
    function applyFX(type) {
        if(type === 'chroma') {
            useChroma = !useChroma;
            document.getElementById('chromaBtn').classList.toggle('active');
        }
        if(type === 'grain') {
            useGrain = !useGrain;
            document.getElementById('grainBtn').classList.toggle('active');
        }
    }

    function toggleSafeZones() {
        const sz = document.getElementById('safe-zone');
        sz.style.display = (sz.style.display === 'block') ? 'none' : 'block';
        document.getElementById('szBtn').classList.toggle('active');
    }

    // --- High Performance Render Loop ---
    function renderLoop() {
        if(video) {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            if(useChroma) {
                let imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
                for(let i=0; i<imgData.data.length; i+=4) {
                    // Optimized Green Screen check
                    let r = imgData.data[i], g = imgData.data[i+1], b = imgData.data[i+2];
                    if(g > 100 && g > r * 1.2 && g > b * 1.2) imgData.data[i+3] = 0;
                }
                ctx.putImageData(imgData, 0, 0);
            }

            if(useGrain) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.05})`;
                for(let i=0; i<800; i++) {
                    ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 2, 2);
                }
            }

            if(isPlaying) {
                const progress = (video.currentTime / video.duration) * 1000;
                document.getElementById('playhead').style.left = progress + 'px';
            }
        }
        requestAnimationFrame(renderLoop);
    }

    // --- Controls ---
    function togglePlayback() {
        if(!video) return;
        isPlaying = !isPlaying;
        if(isPlaying) { video.play(); audio?.play(); }
        else { video.pause(); audio?.pause(); }
        document.getElementById('playIcon').className = isPlaying ? "fa-solid fa-pause" : "fa-solid fa-play";
    }

    document.getElementById('speedRamp').oninput = (e) => {
        if(video) video.playbackRate = e.target.value;
        if(audio) audio.playbackRate = e.target.value;
    };

    function updateSafeZoneUI() {
        const sz = document.getElementById('safe-zone');
        const rect = canvas.getBoundingClientRect();
        sz.style.width = (rect.width * 0.8) + 'px';
        sz.style.height = (rect.height * 0.8) + 'px';
        sz.style.top = (rect.top + (rect.height * 0.1)) + 'px';
        sz.style.left = (rect.left + (rect.width * 0.1)) + 'px';
    }

    // --- Professional Export ---
    async function exportVideo() {
        if(!video) return alert("Please add media first!");
        const stream = canvas.captureStream(30);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm', bitsPerSecond: 8000000 });
        const chunks = [];
        
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = document.getElementById('p-name').value + '.webm';
            a.click();
        };
        
        recorder.start();
        alert("Recording 10 seconds of output...");
        setTimeout(() => recorder.stop(), 10000);
    }

    window.onresize = updateSafeZoneUI;
</script>
</body>
</html>
