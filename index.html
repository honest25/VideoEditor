<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineStudio Pro | Ultimate Hybrid Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --accent: #fbbf24; --bg: #080808; --panel: #121212; }
        body { background: var(--bg); color: #ddd; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .studio-grid { display: grid; grid-template-columns: 300px 1fr 320px; grid-template-rows: 1fr 300px; height: 100vh; }
        .preview-box { background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #222; }
        canvas { background: #000; box-shadow: 0 0 50px rgba(0,0,0,0.5); transition: all 0.3s ease; }
        .timeline { grid-column: 1 / span 3; background: #0a0a0a; border-top: 2px solid #222; overflow-x: auto; position: relative; }
        .track { height: 45px; border-bottom: 1px solid #1a1a1a; display: flex; align-items: center; position: relative; min-width: 5000px; }
        .clip-item { height: 35px; border-radius: 4px; position: absolute; cursor: pointer; display: flex; align-items: center; padding: 0 10px; font-size: 10px; font-weight: bold; overflow: hidden; }
        .video-clip { background: linear-gradient(90deg, #1e40af, #3b82f6); border: 1px solid #60a5fa; }
        .audio-clip { background: linear-gradient(90deg, #065f46, #10b981); border: 1px solid #34d399; }
        .playhead { width: 2px; height: 100%; background: #ff0000; position: absolute; left: 0; z-index: 100; pointer-events: none; }
    </style>
</head>
<body>

<div class="studio-grid">
    <aside class="p-4 border-r border-zinc-800 space-y-4 overflow-y-auto">
        <div class="flex justify-between items-center">
            <span class="text-[10px] font-black tracking-widest text-zinc-500 uppercase">Media Pool</span>
            <label class="bg-amber-500 text-black px-2 py-1 rounded text-[10px] font-bold cursor-pointer">
                ADD MEDIA <input type="file" id="media-input" hidden multiple accept="video/*,audio/*,image/*">
            </label>
        </div>
        <div id="media-list" class="space-y-2"></div>
    </aside>

    <main class="preview-box">
        <div class="absolute top-4 left-4 z-20 flex gap-2">
            <button onclick="setRatio(16/9)" class="bg-zinc-800 px-2 py-1 rounded text-[10px]">16:9</button>
            <button onclick="setRatio(9/16)" class="bg-zinc-800 px-2 py-1 rounded text-[10px]">9:16</button>
            <button onclick="setRatio(1/1)" class="bg-zinc-800 px-2 py-1 rounded text-[10px]">1:1</button>
        </div>
        <canvas id="main-canvas"></canvas>
        <div class="absolute bottom-4 flex gap-4 bg-black/60 p-2 px-6 rounded-full backdrop-blur-md">
            <button onclick="togglePlay()"><i class="fa-solid fa-play" id="play-icon"></i></button>
            <button onclick="startExport()" class="text-xs font-bold text-amber-500 uppercase">Render Master</button>
        </div>
    </main>

    <aside class="p-4 border-l border-zinc-800 overflow-y-auto space-y-6">
        <div>
            <h3 class="text-[10px] font-bold text-amber-500 uppercase mb-4">Audio Controls</h3>
            <label class="text-[10px] opacity-50 uppercase">Volume</label>
            <input type="range" id="vol-ctrl" class="w-full mb-2" min="0" max="2" step="0.1" value="1">
            <label class="text-[10px] opacity-50 uppercase">Pitch</label>
            <input type="range" id="pitch-ctrl" class="w-full" min="0.5" max="2" step="0.1" value="1">
        </div>
        <div>
            <h3 class="text-[10px] font-bold text-blue-500 uppercase mb-4">Transitions & Fades</h3>
            <div class="flex gap-2">
                <button onclick="applyFade('in')" class="flex-1 bg-zinc-900 py-2 text-[10px] rounded hover:bg-zinc-800">FADE IN</button>
                <button onclick="applyFade('out')" class="flex-1 bg-zinc-900 py-2 text-[10px] rounded hover:bg-zinc-800">FADE OUT</button>
            </div>
        </div>
        <div class="p-3 bg-zinc-900 rounded border border-zinc-800">
            <h3 class="text-[10px] font-bold text-green-500 uppercase mb-2">Trimming</h3>
            <div class="flex flex-col gap-2">
                <button onclick="trimClip('start')" class="text-[10px] bg-red-900/20 text-red-500 p-1 rounded border border-red-500/30">Trim Start to Playhead</button>
                <button onclick="trimClip('end')" class="text-[10px] bg-red-900/20 text-red-500 p-1 rounded border border-red-500/30">Trim End to Playhead</button>
            </div>
        </div>
    </aside>

    <footer class="timeline" id="timeline-container">
        <div class="playhead" id="playhead"></div>
        <div class="track" id="v-track"><span class="sticky left-0 bg-zinc-900 px-2 text-[9px] z-10">VIDEO</span></div>
        <div class="track" id="a-track"><span class="sticky left-0 bg-zinc-900 px-2 text-[9px] z-10">AUDIO</span></div>
    </footer>
</div>

<script>
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const mediaInput = document.getElementById('media-input');
    let currentVideo = null, currentAudio = null;
    let isPlaying = false;
    let fadeAlpha = 1;

    // --- SETUP RATIO (Canva/Kine Style) ---
    function setRatio(val) {
        if(val > 1) { canvas.width = 1920; canvas.height = 1080; } // 16:9
        else if(val < 1) { canvas.width = 1080; canvas.height = 1920; } // 9:16
        else { canvas.width = 1080; canvas.height = 1080; } // 1:1
        canvas.style.aspectRatio = val;
    }
    setRatio(16/9);

    // --- MEDIA & MERGE LOGIC ---
    mediaInput.onchange = (e) => {
        Array.from(e.target.files).forEach(file => {
            const url = URL.createObjectURL(file);
            const type = file.type.split('/')[0];
            createTimelineClip(file.name, type, url);
        });
    };

    function createTimelineClip(name, type, url) {
        const div = document.createElement('div');
        div.className = `clip-item ${type === 'video' ? 'video-clip' : 'audio-clip'}`;
        div.style.width = "200px";
        div.style.left = "50px";
        div.innerText = name;
        document.getElementById(type === 'video' ? 'v-track' : 'a-track').appendChild(div);

        if(type === 'video') {
            currentVideo = document.createElement('video');
            currentVideo.src = url;
            currentVideo.muted = true; // Audio handled separately
        } else if(type === 'audio') {
            currentAudio = new Audio(url);
            currentAudio.preservesPitch = false; // For pitch shifting
        }
    }

    // --- ENGINE LOOP ---
    function render() {
        if(currentVideo && isPlaying) {
            ctx.globalAlpha = fadeAlpha;
            ctx.drawImage(currentVideo, 0, 0, canvas.width, canvas.height);
            updatePlayhead();
        }
        requestAnimationFrame(render);
    }

    // --- AUDIO & EFFECTS (DaVinci/Adobe Style) ---
    document.getElementById('vol-ctrl').oninput = (e) => { if(currentAudio) currentAudio.volume = e.target.value; };
    document.getElementById('pitch-ctrl').oninput = (e) => { if(currentAudio) currentAudio.playbackRate = e.target.value; };

    function applyFade(type) {
        let val = type === 'in' ? 0 : 1;
        const intv = setInterval(() => {
            val += type === 'in' ? 0.05 : -0.05;
            fadeAlpha = val;
            if(val >= 1 || val <= 0) clearInterval(intv);
        }, 50);
    }

    // --- PLAYBACK ---
    function togglePlay() {
        isPlaying = !isPlaying;
        if(isPlaying) {
            if(currentVideo) currentVideo.play();
            if(currentAudio) currentAudio.play();
            document.getElementById('play-icon').className = "fa-solid fa-pause";
        } else {
            if(currentVideo) currentVideo.pause();
            if(currentAudio) currentAudio.pause();
            document.getElementById('play-icon').className = "fa-solid fa-play";
        }
    }

    function updatePlayhead() {
        if(!currentVideo) return;
        const progress = (currentVideo.currentTime / currentVideo.duration) * 1000;
        document.getElementById('playhead').style.left = progress + 'px';
    }

    // --- EXPORT MASTER ---
    async function startExport() {
        const stream = canvas.captureStream(60);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm', bitsPerSecond: 5000000 });
        let chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Master_Render.webm'; a.click();
        };
        recorder.start();
        setTimeout(() => recorder.stop(), 5000); // 5 sec render demo
    }

    render();
</script>
</body>
</html>
