<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CineStudio | Hybrid Pro Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --accent: #fbbf24; --bg: #050505; --panel: #111; }
        body { background: var(--bg); color: #eee; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        
        /* Layout Grid */
        .studio-root { display: grid; grid-template-columns: 320px 1fr 320px; grid-template-rows: 1fr 280px; height: 100vh; }
        @media (max-width: 1024px) { .studio-root { grid-template-columns: 1fr; grid-template-rows: 40% 30% 30%; overflow-y: auto; } }

        /* Preview Engine */
        .preview-window { background: radial-gradient(circle, #1a1a1a 0%, #000 100%); position: relative; display: flex; align-items: center; justify-content: center; border: 1px solid #222; }
        canvas { max-height: 90%; aspect-ratio: 9/16; background: #000; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* Timeline Logic */
        .timeline-box { grid-column: 1 / span 3; background: #0a0a0a; border-top: 2px solid #222; overflow-x: auto; position: relative; }
        .playhead { width: 2px; height: 100%; background: #ff4444; position: absolute; left: 100px; z-index: 50; pointer-events: none; box-shadow: 0 0 10px #ff4444; }
        .track { height: 50px; border-bottom: 1px solid #1a1a1a; position: relative; min-width: 5000px; display: flex; align-items: center; }
        .clip { background: linear-gradient(90deg, #1e40af, #3b82f6); height: 35px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); position: absolute; cursor: pointer; }

        /* UI Elements */
        .control-wheel { width: 70px; height: 70px; border-radius: 50%; background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); border: 2px solid #333; cursor: crosshair; }
        input[type="range"] { accent-color: var(--accent); }
    </style>
</head>
<body>

<div class="studio-root">
    <aside class="p-4 border-r border-zinc-800 flex flex-col gap-4 overflow-y-auto">
        <div class="flex justify-between items-center">
            <span class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Project Assets</span>
            <label class="bg-zinc-800 hover:bg-white hover:text-black transition p-1 px-3 rounded text-[10px] cursor-pointer font-bold">IMPORT <input type="file" id="media-loader" hidden accept="video/*"></label>
        </div>
        <div id="asset-grid" class="grid grid-cols-2 gap-2"></div>
        <hr class="border-zinc-800">
        <span class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Canva Overlays</span>
        <button onclick="addOverlayText()" class="text-left p-3 bg-zinc-900 rounded border border-zinc-800 text-xs hover:border-amber-500">Add Cinematic Title</button>
    </aside>

    <main class="preview-window">
        <canvas id="main-canvas"></canvas>
        <div class="absolute bottom-6 flex gap-6 bg-black/80 p-3 px-6 rounded-full border border-white/10 backdrop-blur-lg">
            <button onclick="rewind()"><i class="fa-solid fa-backward"></i></button>
            <button id="play-btn" class="text-amber-500 text-xl"><i class="fa-solid fa-play"></i></button>
            <button onclick="startExport()" class="text-green-500 font-bold text-xs uppercase tracking-widest">Render Master</button>
        </div>
    </main>

    <aside class="p-4 border-l border-zinc-800 overflow-y-auto space-y-6">
        <div>
            <h3 class="text-[10px] font-black text-amber-500 uppercase mb-4">Color Grading</h3>
            <div class="flex justify-around mb-4">
                <div class="flex flex-col items-center gap-1"><div class="control-wheel"></div><span class="text-[8px]">LIFT</span></div>
                <div class="flex flex-col items-center gap-1"><div class="control-wheel"></div><span class="text-[8px]">GAIN</span></div>
            </div>
            <label class="text-[10px] uppercase opacity-50">Exposure</label>
            <input type="range" id="exp" class="w-full mb-2" min="50" max="150" value="100">
            <label class="text-[10px] uppercase opacity-50">Saturation</label>
            <input type="range" id="sat" class="w-full" min="0" max="200" value="100">
        </div>

        <div class="p-4 bg-green-900/10 border border-green-500/20 rounded-lg">
            <h3 class="text-[10px] font-black text-green-500 uppercase mb-3">Hollywood Chroma Key</h3>
            <input type="color" id="key-color" value="#00ff00" class="w-full h-8 bg-transparent mb-2 cursor-pointer">
            <input type="range" id="chroma-tol" class="w-full accent-green-500" min="0" max="200" value="100">
            <button onclick="toggleChroma()" id="chroma-toggle" class="w-full mt-2 py-2 text-[10px] border border-green-500 text-green-500 font-bold uppercase">Activate Keyer</button>
        </div>
    </aside>

    <footer class="timeline-box" id="timeline">
        <div class="playhead" id="playhead"></div>
        <div class="track"><div class="track-header sticky left-0 bg-zinc-900 px-2 text-[9px] z-10">V2 OVERLAY</div></div>
        <div class="track"><div class="track-header sticky left-0 bg-zinc-900 px-2 text-[9px] z-10">V1 MASTER</div></div>
        <div class="track"><div class="track-header sticky left-0 bg-zinc-900 px-2 text-[9px] z-10">A1 AUDIO</div></div>
    </footer>
</div>

<script>
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const mediaLoader = document.getElementById('media-loader');
    let videoSource = null;
    let chromaActive = false;
    let recorder;
    let chunks = [];

    canvas.width = 1080; canvas.height = 1920;

    // --- RENDER ENGINE ---
    function render() {
        if (videoSource) {
            ctx.filter = `brightness(${document.getElementById('exp').value}%) saturate(${document.getElementById('sat').value}%)`;
            ctx.drawImage(videoSource, 0, 0, canvas.width, canvas.height);

            if (chromaActive) {
                let frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = frame.data;
                const hex = document.getElementById('key-color').value;
                const rK = parseInt(hex.slice(1,3),16), gK = parseInt(hex.slice(3,5),16), bK = parseInt(hex.slice(5,7),16);
                const tol = document.getElementById('chroma-tol').value;

                for (let i = 0; i < data.length; i += 4) {
                    const diff = Math.sqrt((data[i]-rK)**2 + (data[i+1]-gK)**2 + (data[i+2]-bK)**2);
                    if (diff < tol) data[i+3] = 0;
                }
                ctx.putImageData(frame, 0, 0);
            }
        }
        requestAnimationFrame(render);
    }

    // --- MEDIA HANDLING ---
    mediaLoader.onchange = (e) => {
        const file = e.target.files[0];
        videoSource = document.createElement('video');
        videoSource.src = URL.createObjectURL(file);
        videoSource.loop = true;
        videoSource.play();
        
        const thumb = document.createElement('div');
        thumb.className = "bg-zinc-900 aspect-video rounded border border-zinc-700 p-2 text-[9px] truncate";
        thumb.innerText = file.name;
        document.getElementById('asset-grid').appendChild(thumb);
    };

    function toggleChroma() {
        chromaActive = !chromaActive;
        const btn = document.getElementById('chroma-toggle');
        btn.classList.toggle('bg-green-500');
        btn.classList.toggle('text-black');
    }

    // --- EXPORT MASTER (Hollywood Render) ---
    async function startExport() {
        chunks = [];
        const stream = canvas.captureStream(60);
        recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9', videoBitsPerSecond: 8000000 });
        
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'CineStudio_Master.webm';
            a.click();
        };
        
        recorder.start();
        alert("Rendering Master... Press 'OK' and wait 10 seconds, then the download will trigger.");
        setTimeout(() => recorder.stop(), 10000); 
    }

    window.onload = render;
</script>
</body>
</html>
